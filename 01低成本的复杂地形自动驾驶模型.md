## 低成本的复杂地形自动驾驶模型

### 研究背景与思维过程

#### 研究背景

自动驾驶已经开始逐步商用，但整套自动驾驶的设备极贵，需要各种精准的传感器以及算力极大的CPU。

并且算法之复杂，没有深厚的算法基础，连入门都相当难。那么有没有可能使用一种比较简单的图像识别和机器学习的算法，又能实现比较复杂地形的自动驾驶？

#### 提出问题与研究解决方案

1. 如何突破地形的限制？

   普通的自动驾驶，基本上是循迹。即需要在地面上画一条线或者多条线，车子通过识别地上的线，来实现自动驾驶。而对于没有线的复杂环境，循迹的算法完全失灵。我们采用一层隐藏层的feedforward模型，反而可以实现大色块识别，从而实现无线自动驾驶

   这个模型最适合的场景是越野路段

2. 如何降低成本，降低学习自动驾驶的成本？

   和动则上万的设备比起来，我们只需要一台树莓派3B+作为运算中枢，便可实现自动驾驶，这样成本便降到了极低

#### 设计思路

- 树莓派作为唯一控制端，通过GPIO口输出相应信号，控制车子的移动。
- 通过TB6612FNG芯片来驱动3个马达(1个转向马达+1个前马达+1个后马达)的旋转速度和旋转方向
- 传感器主要是摄像头和超声波距离传感器。
- LED灯是点缀，实现的是和汽车相应的逻辑：车子只要启动，前灯就会亮起；左转右转时，左右灯闪；后退的时候，尾灯亮



### 原理分析

#### 硬件原理介绍

1. 树莓派3B+

   树莓派是一款基于Linux的单片机计算机。它由英国的树莓派基金会所开发，目的是以低价硬件及自由软件促进学校的基本计算机科学教育

   3B+是目前能买到的最新的型号，与2017年发布

   ![](http://ww1.sinaimg.cn/large/006tNc79gy1g4u1ysgxt4j313q0q8x6p.jpg)

2. TB6612FNG

   一种具有PWM功能的电机驱动模块，该模块相对于传统的L298N效率上提高很多，体积上也大幅度减少，在额定范围内，芯片基本不发热。

   TB6612FNG每通道输出最高1.2 A的连续驱动电流，启动峰值电流达2A/3.2 A(连续脉冲/单脉冲)；有4种电机控制模式：正转/反转/制动/停止；PWM支持频率高达100 kHz

   ![](http://ww4.sinaimg.cn/large/006tNc79gy1g4u20fesqtj30sg0e8jtm.jpg)

3. 树莓派红外摄像头

   鱼眼广角135度带红外夜视，CSI接口

   ![](http://ww3.sinaimg.cn/large/006tNc79ly1g4ur4n0ppej30js0d446f.jpg) 

#### 接线表

| 板载名称 | BCM名称 | 连接内容       | 备注                                    |
| -------- | ------- | -------------- | --------------------------------------- |
| 4        |         | TB6612FNG正极  | 板载是VCC                               |
| 6        |         | TB6612FNG负极  | 板载是和VCC挨着的GND                    |
| 7        | 4       | 前灯正极       |                                         |
| 9        |         | 前灯负极       |                                         |
| 12       | 18      | TB6612FNG PWMA | 前后马达 PWM                            |
| 14       |         | 后灯负极       |                                         |
| 16       | 23      | TB6612FNG AIN1 | 前后马达                                |
| 17       |         | 激光灯正极     |                                         |
| 18       | 24      | TB6612FNG AIN2 | 前后马达                                |
| 22       | 25      | 后灯正极       |                                         |
| 27       | 0       | 左灯正极       |                                         |
| 28       | 1       | 右灯正极       |                                         |
| 29       | 5       | TB6612FNG BIN1 | 转向马达                                |
| 30       |         | 右灯负极       |                                         |
| 31       | 6       | TB6612FNG BIN2 | 转向马达                                |
| 33       | 13      | TB6612FNG PWMB | 转向马达PWM                             |
| 34       |         | 左灯负极       |                                         |
| 36       | 16      | NC             | TB6612FNG的开关，高电平的时候为开启状态 |

### 

### 制作过程

#### 材料

| 材料           | 数量 | 备注                             | 价格 |
| -------------- | ---- | -------------------------------- | ---- |
| 树莓派3B+      | 1    |                                  | 256  |
| 摄像头         | 1    | 鱼眼广角带夜视                   | 98   |
| 32G tf卡       | 1    |                                  | 36   |
| LED            | 8    | 紫色验钞的那种效果最好，白色次之 | 8    |
| DS3231时钟模块 | 1    |                                  | 56   |
| TB6612FNG      | 1    |                                  | 8    |
| 电池盒         | 2    | 串联，带开关                     | 10   |
| 18650电池      | 4    |                                  | 32   |
| 降压模块       | 1    |                                  | 22   |
| 杜邦线         | 若干 | 母对母、母对公                   | 5    |
| micro USB 线   | 1    |                                  | 2    |
|                |      | 合计                             | 533  |

#### 安装

- 装配顺序和注意点
  - 顺序：车身灯线(可选) -> 摄像头 -> 固定树莓派 -> 测试车身灯 -> 测试摄像头 -> 连接马达 -> 降压电路 ->  连接马达驱动板 -> 马达驱动板和树莓派连接 -> 测试马达转向  -> 上螺丝
  - **注意点**	
    - 除了超声波距离传感器用20cm的杜邦线外，其他都用10cm便可，这样就基本上不太需要藏线。细节很重要
    - 所有的接线都要确保线能充分接触到接触点，如果接触面不够，把线皮剥长一点，免得在日后撞几下又掉了，或者接触不良导致各种莫名其妙的问题，还是细节
    - 越野车先大卸八块，把备胎和车子中间的假人都卸掉，把原来的控制电路和天线都弄下来，原来的电源连接线也取走

**1. 车身灯线**

- 接车身灯，共分前后左右4组，每组各2个Led灯并联，故需要先改装一下杜邦线，使得1条杜邦线可以分成2个出口。把杜邦线接口的塑料外壳去掉，按下图示插进去，然后用热缩管热缩一下固定
- 2条母对公，接1条母对母；共四组正线，及四组负线，共使用24条杜邦线。
- 另外，务必要注意，车身灯线的**正极用比较鲜艳的颜色，负极用比较深邃的颜色**。并且拼接的3条线颜色要相同，这样别人在拆装的时候，或者用灯的时候就很容易分辨

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fxqi0i1v8hj32lp0u0hdt.jpg)

- 灯线用下图的方式藏好，接树莓派就显得很容易

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxqhwotc0gj31fr0u0e82.jpg)

- 前灯、左右灯接口的固定方式

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxqi9habf3j31bk0u0npe.jpg)

- 后灯的接线方式见下图

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxr30lcochj31400u01ky.jpg)

**2. 摄像头**

摄像头用橡皮筋固定，就是橡皮筋从左到右套在后面的“人”字塑料架上，然后左右套进摄像头左右两边。这样的好处是固定，但也比较好拆卸。改用尼龙扎带也可以

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fwuu9c5hr8j31kw16onpe.jpg)

**3. 固定树莓派**

- 把车顶卸掉，然后用两个尼龙扎带分别穿过树莓派的4个螺丝孔，固定好。
- 注意：
  - 尼龙扎带不用拉太紧
  - 固定前，要把摄像头的CSI线要放到车顶和树莓派之间

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxqieo3t11j31lt0u0u0x.jpg)

**4. 测试车身灯和测试摄像头**

- 树莓派上电，运行gpio_light_test.py测试车身灯是否ok
- 再运行actions.sh，测试拍照是否ok

**5. 连接马达**

- 驱动马达的线的连接方式见下图，先把开关卸掉，然后从开关的那个空隙把线伸出来

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxih45pndaj31400u0hdu.jpg)

- 另外一面，线从另外一边伸出来。另外，线要注意**一个马达的两条线都用相同颜色**，这样接线的时候就很容易区分
- **注意：**如果是连接TB6612FNG，就不是用公对公，用的是母对公

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxih5j6y4fj31400u01ky.jpg)

**6. 连接降压板**

- 降压模块的安装如下，注意右下角的螺丝，用刀子在底盘上钻一个孔，这样便能轻易固定降压模块。降压模块调到5.2v左右，因为要外接摄像头，还蛮耗电的。另外，这里调高一点，可以让驱动电池反向供电树莓派的时候电压也够
- 现在用的这个usb线，剪开后，**灰色是正极，白色是负极**
- 如果要连接模数转换模块，这里的降压板就要换更小的
- in和out的连接点，不要连接螺丝挤压的那个接口(蓝色接口)，要自己拧线，穿过下面图片箭头指的两个小孔。细节非常重要

**7. 连接马达驱动板**

- 马达驱动电源接VM口和旁边的GND口，电池盒的线接公对母杜邦线，把公的一头的黑色塑料件弄下来，和马达驱动电源的线紧绕连接后再用热缩管热缩固定
- 前后马达用公对母的杜邦线，母接驱动板，公接马达线，一样从底盘引出来

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fxsbkfulbhj30yg0tedka.jpg)

- 固定方式很简单，用一个尼龙扎带，从电池仓出来，然后从中间穿过扎好便可。注意TB6112FNG这个板的后面有个电容，故是垫在底盘的塑料支架上的

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxscsgvsezj31400u04qr.jpg)

- 这是背面，有个电容突出来

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxscuzshunj30vq0tyjx7.jpg)

**8. 马达驱动板和树莓派连接**

- TB6612FNG，体积很小，接起来也很方便

**9. 测试马达方向和超声波传感器**

- 对于TB6612FNG，运行gpio_DCTest_tb6612fng.py文件

**10. 合上车身，完成装配**

- 电源放后面，两边都用尼龙扎带扎好，2个电池作为动力电池，电压刚好，不用再弄降压模块；2个电池作为树莓派的电力，上课就不太需要担心没电

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fx3d1ynwf4j31kw16ou0x.jpg)

- 最后再把前面的两个螺丝上紧就好。注意前面的两个螺丝孔不是特别对口(原来是连接车身的假人的)，如果觉得费劲，上好一个螺丝也行

#### 调试

- 先通过程序，人工控制车子通过需要自动驾驶的路段进行学习，学习的时间最好超过5分钟，会产出2000张左右带控制标记(前后左右以及车速)的图片

- 再通过scipy进行图像识别的机器学习，把场景与控制结合起来形成model文件

- 载入运算后的model文件，把车子放在学习的场景下，车子就会自动开起来

- 下图是其中一张供机器学习的照片

  ![](http://ww4.sinaimg.cn/large/006tNc79gy1g4b8h09apnj30hs0dc0tw.jpg)

#### 模型与实物图

![](http://ww2.sinaimg.cn/large/006tNc79gy1g4b652in21j31hc0u0b2b.jpg)



### 项目特色

#### 新颖性

低成本地实现了相对复杂环境的自动驾驶

#### 先进性

自动越野的场景和四驱小车和匹配，国内目前的自动驾驶小车，更多的是“循迹”，即车子跟随的是一个明确的“线”，如果在一个开放的环境下，则完全不能实现自动驾驶。现在的机器学习方式是视觉识别，识别环境，转换成对小车的控制信号，适用范围更广

#### 实用性

配合四驱车，可以用于比较恶劣地形的勘察

### 作品展望

- 手势识别在很多场景下都非常有用，例如手势开关
- 同样的软硬件配置，可以移植到其他车子上，如下图示，这是一台可以漂移的遥控车，实现的是自动漂移

![](http://ww4.sinaimg.cn/large/006tNc79gy1g4c6qsw7r2j31nd0u0hdt.jpg)