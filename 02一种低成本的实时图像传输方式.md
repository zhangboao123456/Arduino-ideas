## 一种低成本的实时图像传输方式

### 研究背景与思维过程

#### 研究背景

"FPV"——第一人称视角（First Person View），目前大部分的FPV玩法是利用机载无线视频发射设备和遥控端无线接收设备来实现的，成本高，且比较不利于做二次开发

而我们则是利用相当成熟的TCP/IP协议，既实现了简单的实时图像传输，还能够做非常多的二次开发，包括和直播网站的无缝连接

#### 提出问题与研究解决方案

1. 如何降低延迟？

   使用http协议，将JPEG帧从摄像头传输到各种接收端。如Chrome，Firefox，Cambozola，VLC，mplayer和其他能够接收MJPG流的软件，都能够接收

2. 性能如何？

   人眼具有视觉残留的特性，只要每秒拍摄的图片数大于24张(即24帧每秒)，人就会觉得是连续的动画。这种方式占用树莓派大概20%的cpu；同时，延迟在0.05秒左右，少于0.1秒的延迟都是非常优秀的传输延迟。这的确是一种性价比很高的方案
   
   如果把连接方式改成4G模块，则可实现超远距离图像传输
   
3. 如何控制小车的移动？

   使用手机，并且手机上不需要再安装额外的app，适用性非常广

   通过NodeJS启动一个轻量级的WebService，手机登录到这个局域网内的网站中

   通过这个WebService界面可以获取手机内置陀螺仪的gamma和beta值，通过这两个值的换算，转换成控制车子前进、后退、左转、右转，以及速度快慢的命令

4. 如何实现和直播网站的无缝连接？

   把摄像头的视频流转换成RTSP格式，可以使用斗鱼直播的API，实现系统级别的直播实时推送

#### 设计思路

- 树莓派作为唯一控制端，通过GPIO口输出相应信号，控制车子的移动。
- 通过TB6612FNG芯片来驱动3个马达(1个转向马达+1个前马达+1个后马达)的旋转速度和旋转方向
- 摄像头采集到的实时图像流，通过mjpg-streamer实现几乎无延迟传输；通过RTSP协议，实现和直播网站的直连
- LED灯是点缀，实现的是和汽车相应的逻辑：车子只要启动，前灯就会亮起；左转右转时，左右灯闪；后退的时候，尾灯亮



### 原理分析

#### 硬件原理介绍

1. 树莓派3B+

   树莓派是一款基于Linux的单片机计算机。它由英国的树莓派基金会所开发，目的是以低价硬件及自由软件促进学校的基本计算机科学教育

   3B+是目前能买到的最新的型号，与2017年发布

   ![](http://ww1.sinaimg.cn/large/006tNc79gy1g4u1ysgxt4j313q0q8x6p.jpg)

2. TB6612FNG

   一种具有PWM功能的电机驱动模块，该模块相对于传统的L298N效率上提高很多，体积上也大幅度减少，在额定范围内，芯片基本不发热。

   TB6612FNG每通道输出最高1.2 A的连续驱动电流，启动峰值电流达2A/3.2 A(连续脉冲/单脉冲)；有4种电机控制模式：正转/反转/制动/停止；PWM支持频率高达100 kHz

   ![](http://ww4.sinaimg.cn/large/006tNc79gy1g4u20fesqtj30sg0e8jtm.jpg)

3. 树莓派红外摄像头

   鱼眼广角135度带红外夜视，CSI接口

   ![](http://ww3.sinaimg.cn/large/006tNc79ly1g4ur4n0ppej30js0d446f.jpg) 

#### 接线表

| 板载名称 | BCM名称 | 连接内容       | 备注                                    |
| -------- | ------- | -------------- | --------------------------------------- |
| 4        |         | TB6612FNG正极  | 板载是VCC                               |
| 6        |         | TB6612FNG负极  | 板载是和VCC挨着的GND                    |
| 7        | 4       | 前灯正极       |                                         |
| 9        |         | 前灯负极       |                                         |
| 12       | 18      | TB6612FNG PWMA | 前后马达 PWM                            |
| 14       |         | 后灯负极       |                                         |
| 16       | 23      | TB6612FNG AIN1 | 前后马达                                |
| 17       |         | 激光灯正极     |                                         |
| 18       | 24      | TB6612FNG AIN2 | 前后马达                                |
| 22       | 25      | 后灯正极       |                                         |
| 27       | 0       | 左灯正极       |                                         |
| 28       | 1       | 右灯正极       |                                         |
| 29       | 5       | TB6612FNG BIN1 | 转向马达                                |
| 30       |         | 右灯负极       |                                         |
| 31       | 6       | TB6612FNG BIN2 | 转向马达                                |
| 33       | 13      | TB6612FNG PWMB | 转向马达PWM                             |
| 34       |         | 左灯负极       |                                         |
| 36       | 16      | NC             | TB6612FNG的开关，高电平的时候为开启状态 |

### 

### 制作过程

#### 材料

| 材料           | 数量 | 备注                             | 价格 |
| -------------- | ---- | -------------------------------- | ---- |
| 树莓派3B+      | 1    |                                  | 256  |
| 摄像头         | 1    | 鱼眼广角带夜视                   | 98   |
| 32G tf卡       | 1    |                                  | 36   |
| LED            | 8    | 紫色验钞的那种效果最好，白色次之 | 8    |
| DS3231时钟模块 | 1    |                                  | 56   |
| TB6612FNG      | 1    |                                  | 8    |
| 电池盒         | 2    | 串联，带开关                     | 10   |
| 18650电池      | 4    |                                  | 32   |
| 降压模块       | 1    |                                  | 22   |
| 杜邦线         | 若干 | 母对母、母对公                   | 5    |
| micro USB 线   | 1    |                                  | 2    |
|                |      | 合计                             | 533  |

#### 安装

- 装配顺序和注意点
  - 顺序：车身灯线(可选) -> 摄像头 -> 固定树莓派 -> 测试车身灯 -> 测试摄像头 -> 连接马达 -> 降压电路 ->  连接马达驱动板 -> 马达驱动板和树莓派连接 -> 测试马达转向  -> 上螺丝
  - **注意点**	
    - 除了超声波距离传感器用20cm的杜邦线外，其他都用10cm便可，这样就基本上不太需要藏线。细节很重要
    - 所有的接线都要确保线能充分接触到接触点，如果接触面不够，把线皮剥长一点，免得在日后撞几下又掉了，或者接触不良导致各种莫名其妙的问题，还是细节
    - 越野车先大卸八块，把备胎和车子中间的假人都卸掉，把原来的控制电路和天线都弄下来，原来的电源连接线也取走

**1. 车身灯线**

- 接车身灯，共分前后左右4组，每组各2个Led灯并联，故需要先改装一下杜邦线，使得1条杜邦线可以分成2个出口。把杜邦线接口的塑料外壳去掉，按下图示插进去，然后用热缩管热缩一下固定
- 2条母对公，接1条母对母；共四组正线，及四组负线，共使用24条杜邦线。
- 另外，务必要注意，车身灯线的**正极用比较鲜艳的颜色，负极用比较深邃的颜色**。并且拼接的3条线颜色要相同，这样别人在拆装的时候，或者用灯的时候就很容易分辨

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fxqi0i1v8hj32lp0u0hdt.jpg)

- 灯线用下图的方式藏好，接树莓派就显得很容易

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxqhwotc0gj31fr0u0e82.jpg)

- 前灯、左右灯接口的固定方式

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxqi9habf3j31bk0u0npe.jpg)

- 后灯的接线方式见下图

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxr30lcochj31400u01ky.jpg)

**2. 摄像头**

摄像头用橡皮筋固定，就是橡皮筋从左到右套在后面的“人”字塑料架上，然后左右套进摄像头左右两边。这样的好处是固定，但也比较好拆卸。改用尼龙扎带也可以

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fwuu9c5hr8j31kw16onpe.jpg)

**3. 固定树莓派**

- 把车顶卸掉，然后用两个尼龙扎带分别穿过树莓派的4个螺丝孔，固定好。
- 注意：
  - 尼龙扎带不用拉太紧
  - 固定前，要把摄像头的CSI线要放到车顶和树莓派之间

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxqieo3t11j31lt0u0u0x.jpg)

**4. 测试车身灯和测试摄像头**

- 树莓派上电，运行gpio_light_test.py测试车身灯是否ok
- 再运行actions.sh，测试拍照是否ok

**5. 连接马达**

- 驱动马达的线的连接方式见下图，先把开关卸掉，然后从开关的那个空隙把线伸出来

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxih45pndaj31400u0hdu.jpg)

- 另外一面，线从另外一边伸出来。另外，线要注意**一个马达的两条线都用相同颜色**，这样接线的时候就很容易区分
- **注意：**如果是连接TB6612FNG，就不是用公对公，用的是母对公

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fxih5j6y4fj31400u01ky.jpg)

**6. 连接降压板**

- 降压模块的安装如下，注意右下角的螺丝，用刀子在底盘上钻一个孔，这样便能轻易固定降压模块。降压模块调到5.2v左右，因为要外接摄像头，还蛮耗电的。另外，这里调高一点，可以让驱动电池反向供电树莓派的时候电压也够
- 现在用的这个usb线，剪开后，**灰色是正极，白色是负极**
- 如果要连接模数转换模块，这里的降压板就要换更小的
- in和out的连接点，不要连接螺丝挤压的那个接口(蓝色接口)，要自己拧线，穿过下面图片箭头指的两个小孔。细节非常重要

**7. 连接马达驱动板**

- 马达驱动电源接VM口和旁边的GND口，电池盒的线接公对母杜邦线，把公的一头的黑色塑料件弄下来，和马达驱动电源的线紧绕连接后再用热缩管热缩固定
- 前后马达用公对母的杜邦线，母接驱动板，公接马达线，一样从底盘引出来

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fxsbkfulbhj30yg0tedka.jpg)

- 固定方式很简单，用一个尼龙扎带，从电池仓出来，然后从中间穿过扎好便可。注意TB6112FNG这个板的后面有个电容，故是垫在底盘的塑料支架上的

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fxscsgvsezj31400u04qr.jpg)

- 这是背面，有个电容突出来

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fxscuzshunj30vq0tyjx7.jpg)

**8. 马达驱动板和树莓派连接**

- TB6612FNG，体积很小，接起来也很方便

**9. 测试马达方向和超声波传感器**

- 对于TB6612FNG，运行gpio_DCTest_tb6612fng.py文件

**10. 合上车身，完成装配**

- 电源放后面，两边都用尼龙扎带扎好，2个电池作为动力电池，电压刚好，不用再弄降压模块；2个电池作为树莓派的电力，上课就不太需要担心没电

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fx3d1ynwf4j31kw16ou0x.jpg)

- 最后再把前面的两个螺丝上紧就好。注意前面的两个螺丝孔不是特别对口(原来是连接车身的假人的)，如果觉得费劲，上好一个螺丝也行

#### 调试

- 手机做方向盘

  - 通过NodeJS启动一个轻量级的WebService，端口是8900
  - 手机打开浏览器(安卓或者苹果都行)，输入http://树莓派ip地址:8900，便可看到控制界面
  - 这个界面可以获取手机内置陀螺仪的gamma和beta值，通过这两个值的换算，转换成控制车子前进、后退、左转、右转，以及速度快慢的命令

  **注意：**手机和车子需在同一个局域网中

- 实时图像传输

  - 启动Motion或者MJPG-Streamer服务，也是一个WebService，端口是8080。打开之后，能实时看到树莓派摄像头拍到的内容，就像是通过车子的眼睛“看”到ta眼里的世界
  - Motion和MJPG-Streamer都是通过调用摄像头快速拍照(例如1秒拍20张)，来实现实时画面更新，技术虽然老，但非常好用，和TCP或者UDP协议相比，几乎没有延时
  - 基于TCP协议的话，主要有HLS/RTSP/RTMP这几种实时传输方式，其中直播网站多数采用RTSP(例如斗鱼)。即，可以实时在斗鱼上发起一个车子当前视角的直播，那也是蛮酷的
  - 除了TCP外，还可以用UDP协议，例如使用NodeJS启动一个WebService，但由于没有校验，网络环境不好的时候，丢失画面的现象比较严重
  - 下图是车子的实时画面，摄像头带红外夜视功能，即便是眼前一片漆黑，也依然能够看清楚路

  ![](http://ww2.sinaimg.cn/large/006tNc79gy1g4b9ks12esj30hs0dcjs3.jpg)

#### 模型与实物图

![](http://ww1.sinaimg.cn/large/006tNc79gy1g4c6nbkv66j31900u0u0y.jpg)



### 项目特色

#### 新颖性

- 通过NodeJS启动WebService的方式，能适配目前市面上99%的手机，且手机不需要先安装一个App，使用自带的浏览器便可以控制车子，极大地减少了使用步骤、降低了使用难度
- 使用TCP/IP来实现的实时画面传播，能把现有硬件全部用起来，实现和基于直连的FPV差不多的实时传输效果，不用再另购硬件设备，节省成本之余，还可以自行编程，方便实现智能控制

#### 先进性

- 整个传输步骤支持4G，甚至5G

#### 实用性

- 手机自带的浏览器是一个“超级App”，通过浏览器能获取非常多的和手机有关的信息和状态数据，能够做很多事情。通过这样的方式实现“去App化”，一方面能低成本和快速地出demo；一方面不需要考虑繁琐无比的屏幕适配问题。功能性应用，使用此方式无疑非常合适
- 实时图像传输，适用于远距离控制。如果加上4G模块，则可利用4G网络实现超远距离控制，这是传统的FPV方式所不能比拟的优势
- 整套软硬件能够移植到其他类型的小车上

### 作品展望

- 手势识别在很多场景下都非常有用，例如手势开关
- 同样的软硬件配置，可以移植到其他车子上，如下图示，这是一台可以漂移的遥控车，实现的是自动漂移

![](http://ww4.sinaimg.cn/large/006tNc79gy1g4c6qsw7r2j31nd0u0hdt.jpg)